# Flywheel Energy Storage Analysis - ME 4053 Project 3

**Team #16**
- Pokhrel, Nesha
- Zhang, Zhihan
- Hondl, Sebastian
- Rios, Madigan

## Project Overview

This project analyzes the design and control of a flywheel energy storage system for power grid applications. The analysis includes:

1. **Baseline System Analysis**: Evaluate existing flywheel design performance
2. **New Design Optimization**: Optimize flywheel for a new storage cycle
3. **AMB Controller Design**: Design magnetic bearing control system

## Project Structure

```
flywheel_analysis/
├── README.md                          # This file
├── documentation/
│   ├── ASSUMPTIONS.md                 # All assumptions made
│   └── ADDITIONAL_INFO_NEEDED.md      # Data still required
├── ee_functions/                      # Electrical engineering team functions
│   ├── magneticShear.m               # Magnetic shear stress calculation
│   ├── rotorLosses.m                 # Rotor loss calculation
│   ├── statorLosses.m                # Stator loss calculation
│   └── ambParameters.m               # AMB parameter lookup
├── utilities/                         # Shared utility functions
│   ├── flywheelEnergy.m              # Energy calculations
│   ├── soc2speed.m                   # SoC to speed conversion
│   ├── speed2soc.m                   # Speed to SoC conversion
│   ├── calculateFlywheelDimensions.m # Geometry sizing
│   ├── calculateRotatingGroupMass.m  # Mass and inertia calculations
│   ├── calculateRotorTemperature.m   # Thermal analysis
│   └── simulateStorageCycle.m        # Storage cycle simulation
├── baseline_analysis/                 # Baseline system analysis (Deliverable 1)
│   ├── baseline_config.m             # Baseline system parameters
│   └── analyze_baseline.m            # Main analysis script
├── new_design/                        # New design optimization (Deliverable 2)
│   ├── design_optimization.m         # Design space exploration
│   └── createDesignConfig.m          # Design configuration creator
├── amb_controllers/                   # AMB control design (Deliverable 3)
│   ├── design_amb_controller.m       # Controller design function
│   ├── simulate_amb_response.m       # Step response simulation
│   ├── calculate_dynamic_stiffness.m # Dynamic stiffness calculation
│   └── calculate_rotor_runout.m      # Runout due to imbalance
└── results/                           # Output folder for figures and data
    └── (generated by running scripts)
```

## Quick Start Guide

### 1. First-Time Setup

```matlab
% Navigate to the flywheel_analysis folder
cd flywheel_analysis

% Verify folder structure
ls
```

### 2. Update Critical Files

**BEFORE running any analysis**, update these files with actual data:

#### a. Replace EE Functions (from Canvas)
- Download actual functions from Canvas
- Replace files in `ee_functions/` folder
- Verify with: `help magneticShear`

#### b. Update Baseline Configuration
- Edit `baseline_analysis/baseline_config.m`
- Replace assumed parameters with Appendix A values
- Look for comments marked "ASSUMED - REPLACE WITH APPENDIX A"

#### c. Load Storage Cycle Data
- Download Team #16 storage cycle from Canvas
- Edit `new_design/design_optimization.m`
- Replace placeholder cycle (around line 20)

Example:
```matlab
% Replace this in design_optimization.m:
data = readmatrix('../path_to_team16_cycle.csv');
t_new_cycle = data(:, 1);  % Time [s]
P_new_cycle = data(:, 2);  % Power [W]
```

### 3. Run Baseline Analysis

```matlab
% Navigate to baseline analysis folder
cd baseline_analysis

% Run analysis
analyze_baseline

% Check results
cd ../results
ls
```

**Outputs**:
- `baseline_losses_temp_vs_soc.fig/png` - Losses and temperature plots
- `baseline_storage_cycle.fig/png` - Storage cycle simulation
- `baseline_results.mat` - All numerical results

**Note**: AMB analysis (parts 1d, 1e, 1f) requires controller design first.

### 4. Run Design Optimization

```matlab
% Navigate to new design folder
cd ../new_design

% Run optimization (may take several minutes)
design_optimization

% Check results
cd ../results
ls
```

**Outputs**:
- `design_tradeoffs_3d.fig/png` - Design space visualization
- `design_optimization_results.mat` - All design data
- Console output shows optimal design parameters

### 5. Design AMB Controllers

```matlab
% Example: Design controller for baseline system
cd ../baseline_analysis
config = baseline_config();

% Add necessary paths
addpath('../amb_controllers');
addpath('../utilities');

% Design controllers
target_bandwidth = 50; % Hz
damping_ratio = 0.7;

controller_top = design_amb_controller(config.amb_top, ...
                                       config.mass_total/2, ...
                                       target_bandwidth, ...
                                       damping_ratio);

controller_bottom = design_amb_controller(config.amb_bottom, ...
                                          config.mass_total/2, ...
                                          target_bandwidth, ...
                                          damping_ratio);

% Simulate step response
t_sim = linspace(0, 0.1, 1000); % 100 ms
F_dist = 0.1 * config.F_amb_rating; % 10% of rated force

response = simulate_amb_response(controller_top, F_dist, 0, t_sim);

% Plot response
figure;
subplot(3,1,1);
plot(response.t*1000, response.x*1e6);
xlabel('Time [ms]');
ylabel('Position [μm]');
title('AMB Step Response - Position');
grid on;

subplot(3,1,2);
plot(response.t*1000, response.i);
xlabel('Time [ms]');
ylabel('Current [A]');
title('Current Response');
grid on;

subplot(3,1,3);
plot(response.t*1000, response.F_amb);
xlabel('Time [ms]');
ylabel('Force [N]');
title('AMB Force');
grid on;
```

### 6. Calculate Dynamic Stiffness

```matlab
freq_array = logspace(0, 3, 100); % 1 Hz to 1 kHz

stiffness = calculate_dynamic_stiffness(config, ...
                                        controller_top, ...
                                        controller_bottom, ...
                                        freq_array);

% Plot
figure;
subplot(2,1,1);
loglog(stiffness.freq, stiffness.K_radial/1e6);
grid on;
xlabel('Frequency [Hz]');
ylabel('Radial Stiffness [MN/m]');
title('Dynamic Stiffness vs Frequency');

subplot(2,1,2);
loglog(stiffness.freq, stiffness.K_tilting);
grid on;
xlabel('Frequency [Hz]');
ylabel('Tilting Stiffness [N·m/rad]');
```

### 7. Calculate Rotor Runout

```matlab
% Speed array from 0 to max
SoC_array = linspace(0, 1, 50);
omega_array = soc2speed(SoC_array, config.omega_max);

% Mass imbalance (assumed 1 g·m)
imbalance = 1e-3; % kg·m

runout = calculate_rotor_runout(config, controller_top, ...
                                controller_bottom, omega_array, imbalance);

% Plot
figure;
plot(SoC_array*100, runout.x_max_mm);
grid on;
xlabel('State of Charge [%]');
ylabel('Radial Runout [mm]');
title('Rotor Runout vs SoC (1 g·m imbalance)');
```

## Key Deliverables Checklist

### Deliverable 1: Baseline System Analysis

- [ ] 1a. Plot losses and temperature vs SoC at rated power
  - Run: `baseline_analysis/analyze_baseline.m`

- [ ] 1b. Specific power and specific energy
  - Calculated in: `analyze_baseline.m` (see console output)

- [ ] 1c. Storage cycle efficiency
  - Calculated in: `analyze_baseline.m` (requires actual cycle)

- [ ] 1d. AMB step response (x-direction, 0 speed and 100% SoC)
  - Use: `simulate_amb_response.m` (see section 5 above)

- [ ] 1e. Dynamic stiffness vs frequency
  - Use: `calculate_dynamic_stiffness.m` (see section 6 above)

- [ ] 1f. Rotor runout vs SoC
  - Use: `calculate_rotor_runout.m` (see section 7 above)

### Deliverable 2: New Design Optimization

- [ ] 2a. Design trade-off plots
  - Run: `new_design/design_optimization.m`
  - Output: 3D plot of specific power vs specific energy vs efficiency

- [ ] 2b. Select optimal design with justification
  - Review: `design_optimization_results.mat`
  - Adjust weights in script if needed
  - Document: Component dimensions, justification

### Deliverable 3: AMB Controller Design for New System

- [ ] 3a. Transfer functions for controllers
  - Use: `design_amb_controller.m` on optimal design
  - Extract: `controller.Gc_pos` and `controller.Gc_curr`

- [ ] 3b. Compare AMB step response to baseline
  - Run both baseline and new design
  - Plot side-by-side

- [ ] 3c. Compare dynamic stiffness and runout to baseline
  - Generate for both systems
  - Create comparison plots

## Common Issues and Solutions

### Issue: "Undefined function or variable"
**Solution**: Make sure you've added the necessary paths:
```matlab
addpath('../utilities');
addpath('../ee_functions');
addpath('../amb_controllers');
```

Or run from the specific subdirectory containing the script.

### Issue: "WARNING: Using placeholder AMB parameters"
**Solution**: This is expected! Placeholder EE functions print warnings. Replace with actual functions from Canvas.

### Issue: "No feasible designs found"
**Solution**:
1. Check that storage cycle data is correct
2. Expand design space (wider speed/magnet thickness ranges)
3. Review constraints (temperature, SoC limits)

### Issue: Thermal solution doesn't converge
**Solution**:
- Check that power losses are reasonable (not too high)
- Verify dimensions are physically realistic
- May need to adjust iteration parameters in `calculateRotorTemperature.m`

## Tips for Report Writing

1. **Use actual data**: Replace ALL placeholder data before final analysis
2. **Save figures**: All scripts save figures to `results/` folder
3. **Document assumptions**: Reference `documentation/ASSUMPTIONS.md`
4. **Show trade-offs**: Use 3D plots and Pareto frontiers
5. **Justify selection**: Explain why optimal design was chosen
6. **Compare to baseline**: Always show new design vs baseline

## MATLAB Version Compatibility

Tested with:
- MATLAB R2021a and later
- Required toolboxes:
  - Control System Toolbox (for transfer functions)
  - Signal Processing Toolbox (for bode plots)

If you don't have these toolboxes, some functions may need modification.

## Contact and Questions

**For technical questions**:
- Check `documentation/ADDITIONAL_INFO_NEEDED.md`
- Ask team members first
- Office hours with Prof. Anderson or Prof. Severson

**For missing data**:
- Canvas → Project 3 folder
- Email instructors if files are not posted

## Next Steps

1. ✅ Understand project structure (you're reading this!)
2. ⬜ Obtain Appendix A from project PDF or Canvas
3. ⬜ Download Team #16 storage cycle from Canvas
4. ⬜ Download actual EE functions from Canvas
5. ⬜ Update configuration files with real data
6. ⬜ Run baseline analysis
7. ⬜ Run design optimization
8. ⬜ Design AMB controllers
9. ⬜ Generate all required plots and results
10. ⬜ Write report

Good luck with your project!
